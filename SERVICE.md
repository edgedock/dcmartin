# `SERVICE.md` - _Service_ build process automation

The `make` targets for services **require** the installation of the Open Horizon command-line-tool: `hzn` and publishing requires a public/private key-pair generated by the `hzn` command; for example:

```
hzn key create MYORG my-email@my-domain.tld
```

Open Horizon is available for a variety of architectures and platforms.  For more information please refer to the [`setup/README.md`][setup-readme-md].

# 1. Building a service

Each of the services in this [repository][repository] are built using a common `Makefile`, which shared via symbolic link to the [`service.makefile`][service-makefile] in the repository top-level.  In addition, all services share a common design (see [`DESIGN.md`][design-md]) and a shared implementation architecture for simplicity.  

### Step 1
When the service is properly configured (see _Configuring a service_) the build process for a service is straight-forward:

```
make service-build
```
### Step 2
If all supported architectures are built successfully, each may be tested:

```
make service-test
```
### Step 3
Finally, if all tests complete successfully, the service may be published:

```
make service-publish
```

# 2. Configuring a service

Each service is composed of multiple artifacts:

+ `build.json` - a definition of the architecture labels and the associated image from which to build (see [`BUILD.md`][build-md]).
+ `service.json` - a template of the service definition for components and configuration
+ `userinput.json` - a template for registration configuration

## 2.1 `build.json` - build configuration definition
The build definition contains information used when building the Docker container, notably a specification of supported architecture labels and corresponding `BUILD_FROM` Docker container image tags, for example the `base-ubuntu` example (see below) indicates three (3) supported architectures with corresponding tags.  Most of the services in this [repository][repository] utilize _base_ containers that are also in this repository.  For example, `yolo4motion` utilizes `yolo`, and `yolo` is built from the `base-ubuntu` container:

### `base-ubuntu/build.json`
```
    "build_from": {
        "amd64": "ubuntu:bionic",
        "arm": "arm32v7/ubuntu:bionic",
        "arm64": "arm64v8/ubuntu:bionic"
    },
```
### `yolo/build.json`
```
  "build_from": {
    "amd64": "dcmartin/amd64_base-ubuntu:0.0.2",
    "arm": "dcmartin/arm_base-ubuntu:0.0.2",
    "arm64": "dcmartin/arm64_base-ubuntu:0.0.2"
  },
```
### `yolo4motion/build.json`
```
  "build_from": {
    "arm64": "dcmartin/arm64_yolo:0.0.5",
    "amd64": "dcmartin/amd64_yolo:0.0.5",
    "arm": "dcmartin/arm_yolo:0.0.5"
  },
```

## 2.2 `service.json` - service configuration _template_

The service template definition includes four (4) important fields that are used in service identification:

+ `org` - the organization for the service
+ `version` - the version of the service; this value is encoded for [semantic versioning][semver]
+ `url` - a unique identifier for the service (e.g. `com.github.dcmartin.open-horizon`)
+ `arch` - an architecture label (e.g. `amd64`)

The value of these fields are combined together to uniquely identify each service in the exchange; for example:

```
dcmartin@us.ibm.com/com.github.dcmartin.open-horizon.yolo2msghub_0.0.9_amd64
```

In addition to these identifying attributes, the `label` field identifies the service in a more human-readable form.  This field should be URL _encoded_ if spaces or other special characters are required.  Note that the `arch` attribute in the service configuration template is `null`; that value will be generated during the build process. For additional information on the service definition attributes, please refer to the documentation.

```
  "org": "dcmartin@us.ibm.com",
  "version": "0.0.9",
  "url": "com.github.dcmartin.open-horizon.yolo2msghub",
  "arch": null,
  "label": "yolo2msghub",
  "description": "Sends JSON payloads from yolo service to Kafka",
  "documentation": "https://github.com/dcmartin/open-horizon/yolo2msghub/README.md",
  "public": true,
  "sharable": "singleton",
```

#### 2.2.1`requiredServices` 
This field is an array of identifying attributes for each service on which the service depends.  The `arch` field is `null` and will be populated according to the architecture when built.

```
  "requiredServices": [
    { "url": "com.github.dcmartin.open-horizon.yolo", "org": "dcmartin@us.ibm.com", "version": "0.0.4", "arch": null },
    { "url": "com.github.dcmartin.open-horizon.wan", "org": "dcmartin@us.ibm.com", "version": "0.0.1", "arch": null },
    { "url": "com.github.dcmartin.open-horizon.hal", "org": "dcmartin@us.ibm.com", "version": "0.0.1", "arch": null },
    { "url": "com.github.dcmartin.open-horizon.cpu", "org": "dcmartin@us.ibm.com", "version": "0.0.2", "arch": null }
  ],
```

#### 2.2.2 `userInput`
This field is an array of variables that may be used to configure the service; variables with a `defaultValue` of `null` are mandatory.

```
  "userInput": [
    { "name": "YOLO2MSGHUB_APIKEY", "label": "message hub API key", "type": "string", "defaultValue": null },
    { "name": "YOLO2MSGHUB_ADMIN_URL", "label": "administrative URL", "type": "string", "defaultValue": "https://kafka-admin-prod02.messagehub.services.us-south.bluemix.net:443"},
    { "name": "YOLO2MSGHUB_BROKER", "label": "message hub broker list", "type": "string", "defaultValue": "kafka05-prod02.messagehub.services.us-south.bluemix.net:9093,kafka01-prod02.messagehub.services.us-south.bluemix.net:9093,kafka03-prod02.messagehub.services.us-south.bluemix.net:9093,kafka04-prod02.messagehub.services.us-south.bluemix.net:9093,kafka02-prod02.messagehub.services.us-south.bluemix.net:9093" },
    { "name": "YOLO2MSGHUB_PERIOD", "label": "update interval", "type": "int", "defaultValue": "30" },
    { "name": "LOCALHOST_PORT", "label": "localhost port", "type": "int", "defaultValue": "8587" },
    { "name": "LOG_LEVEL", "label": "specify logging level", "type": "string", "defaultValue": "info" },
    { "name": "DEBUG", "label": "debug on/off", "type": "boolean", "defaultValue": "false" }
  ],
```

#### 2.2.3 `deployment`
This field is a dictionary of `services` that are included in the service deployment.  Each entry in the dictionary provides specifics, including key name (e.g. `yolo2msghub` in example below) as well as other deployment options and configuration.  The `environment` section is deprecated, but used in these services design to convey the service's `label` value.

```
  "deployment": {
    "services": {
      "yolo2msghub": {
        "environment": [
          "SERVICE_LABEL=yolo2msghub"
        ],
        "devices": null,
        "binds": null,
        "specific_ports": [ { "HostPort": "8587:8587/tcp", "HostIP": "0.0.0.0" } ],
        "image": null,
        "privileged": false
      }
    }
  },
```

[service-makefile]: https://github.com/dcmartin/open-horizon/blob/master/service.makefile
[semver]: https://semver.org/

## 2.3 `userinput.json`

The template for registration configuration includes specification of environment variables that will be defined for the service and any required services; for example, the `yolo2msghub/userinput.json` specifies variables for four (4) services:

```
{
  "global": [],
  "services": [
    {
      "org": "dcmartin@us.ibm.com",
      "url": "com.github.dcmartin.open-horizon.yolo2msghub",
      "versionRange": "[0.0.0,INFINITY)",
      "variables": { "YOLO2MSGHUB_APIKEY": null, "LOCALHOST_PORT": 8587, "LOG_LEVEL": "info", "DEBUG": false }
    },
    {
      "org": "dcmartin@us.ibm.com",
      "url": "com.github.dcmartin.open-horizon.yolo",
      "versionRange": "[0.0.0,INFINITY)",
      "variables": { "YOLO_ENTITY": "person", "YOLO_PERIOD": 60, "YOLO_CONFIG": "tiny", "YOLO_THRESHOLD": 0.25 }
    },
    {
      "org": "dcmartin@us.ibm.com",
      "url": "com.github.dcmartin.open-horizon.cpu",
      "versionRange": "[0.0.0,INFINITY)",
      "variables": { "CPU_PERIOD": 60 }
    },
    {
      "org": "dcmartin@us.ibm.com",
      "url": "com.github.dcmartin.open-horizon.wan",
      "versionRange": "[0.0.0,INFINITY)",
      "variables": { "WAN_PERIOD": 900 }
    },
    {
      "org": "dcmartin@us.ibm.com",
      "url": "com.github.dcmartin.open-horizon.hal",
      "versionRange": "[0.0.0,INFINITY)",
      "variables": { "HAL_PERIOD": 1800 }
    }
  ]
}
```

# 3. `make` targets

The build process for each service is identical.  The _default_ `make` target is to `build`, `run`, and `check` the  service locally using the native architecture.  These targets only support a single Docker container image do _not_ include the required services.  More information is available in [`BUILD.md`][build-md] and [`MAKE.md`][make-md].

+ `service-build` - build Docker container images for all supported architectures
+ `service-push` - push the Docker container images to registry (n.b. `DOCKER_HUB_ID`; see [`MAKEVARS.md`][makevars-md])
+ `service-start` - starts the services and required services 
+ `service-test` - tests the _started_ service using `test-{service}.sh` for conformant status payload
+ `service-stop` - stops the services and required services
+ `service-publish` - publish the service in the exchange for all supported architectures
+ `service-verify` - verifies the published service in the exchange

## 3.1 `service-build` & `service-push`

These targets will build and push, respectively, the service for all supported architectures; multi-architecture emulation using QEMU is TBD.
## 3.2 `service-start`

This target will ensure that the service is built and then initiate the service using the `hzn` CLI commands.  All services specified, including required services, will also be initiated and appropriate virtual private networks will be established.  Please refer to the Open Horizon documentation for more details on the `hzn` command-line-interface.

## 3.3 `service-test`

This target may be used against the local container, the local service (n.b. see `start` target), or any node running the _service_.  The service is accessed on its external `port` without mapping.  The payload is processed into a JSON type structure, including _object_, _array_, _number_, _string_.

```
{
  "hzn": {
    "agreementid": "string",
    "arch": "string",
    "cpus": "number",
    "device_id": "string",
    "exchange_url": "string",
    "host_ips": [
      "string"
    ],
    "organization": "string",
    "pattern": "string",
    "ram": "number"
  },
  "date": "number",
  "service": "string",
  "hostname": "string",
  "pid": "number",
  "cpu": {
    "date": "number",
    "log_level": "string",
    "debug": "boolean",
    "period": "number",
    "interval": "number",
    "percent": "number"
  }
}
```

## 3.4 `service-stop`

This target will stop the services and all required services initiated using the `service-start` target.

## 3.5 `service-publish`

This target pushes the Docker container images into the registry and publishes the service with the identifier (see above) and the corresponding registry image tag, e.g. `dcmartin/arm64_yolo2msghub_0.0.9`.

## 3.6 `service-verify`

This target will verify that the service is published into the exchange.

[docker-start]: https://www.docker.com/get-started
[make-md]: https://github.com/dcmartin/open-horizon/blob/master/MAKE.md
[build-md]: https://github.com/dcmartin/open-horizon/blob/master/BUILD.md
[makevars-md]: https://github.com/dcmartin/open-horizon/blob/master/MAKEVARS.md
[setup-readme-md]: https://github.com/dcmartin/open-horizon/blob/master/setup/README.md

[travis-md]: https://github.com/dcmartin/open-horizon/blob/master/TRAVIS.md
[design-md]: https://github.com/dcmartin/open-horizon/blob/master/DESIGN.md
[travis-yaml]: https://github.com/dcmartin/open-horizon/blob/master/.travis.yml
[travis-ci]: https://travis-ci.org/
[build-pattern-video]: https://youtu.be/cv_rOdxXidA

[yolo-service]: https://github.com/dcmartin/open-horizon/tree/master/yolo/README.md
[hal-service]: https://github.com/dcmartin/open-horizon/tree/master/hal/README.md
[cpu-service]: https://github.com/dcmartin/open-horizon/tree/master/cpu/README.md
[wan-service]: https://github.com/dcmartin/open-horizon/tree/master/wan/README.md
[yolo2msghub-service]: https://github.com/dcmartin/open-horizon/tree/master/yolo2msghub/README.md
[motion2mqtt-service]: https://github.com/dcmartin/open-horizon/tree/master/motion2mqtt/README.md

## Changelog & Releases

Releases are based on Semantic Versioning, and use the format
of ``MAJOR.MINOR.PATCH``. In a nutshell, the version will be incremented
based on the following:

- ``MAJOR``: Incompatible or major changes.
- ``MINOR``: Backwards-compatible new features and enhancements.
- ``PATCH``: Backwards-compatible bugfixes and package updates.

## Authors & contributors

David C Martin (github@dcmartin.com)

[commits]: https://github.com/dcmartin/open-horizon/commits/master
[contributors]: https://github.com/dcmartin/open-horizon/graphs/contributors
[dcmartin]: https://github.com/dcmartin
[edge-fabric]: https://console.test.cloud.ibm.com/docs/services/edge-fabric/getting-started.html
[edge-install]: https://console.test.cloud.ibm.com/docs/services/edge-fabric/adding-devices.html
[edge-slack]: https://ibm-cloudplatform.slack.com/messages/edge-fabric-users/
[ibm-apikeys]: https://console.bluemix.net/iam/#/apikeys
[ibm-registration]: https://console.bluemix.net/registration/
[issue]: https://github.com/dcmartin/open-horizon/issues
[macos-install]: http://pkg.bluehorizon.network/macos
[open-horizon]: http://github.com/open-horizon/
[repository]: https://github.com/dcmartin/open-horizon
[setup]: https://github.com/dcmartin/open-horizon/blob/master/setup/README.md
